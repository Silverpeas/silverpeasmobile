if (firebaseConfig != null) {

  importScripts('/silverpeas/spmobile/firebasejs/7.12.0/firebase-app.js');
  importScripts('/silverpeas/spmobile/firebasejs/7.12.0/firebase-messaging.js');

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

  const messaging = firebase.messaging();

  // In page notification management
  self.addEventListener('push', function(event) {
    if (event.srcElement) {
    event.srcElement.onnotificationclick = function(ev) {
      const pushData = ev.notification.data;
      ev.notification.close();
      self.clients.openWindow(pushData["permalink"]);
      }
    };
  });

  messaging.setBackgroundMessageHandler(function(payload) {
    console.log('[firebase-messaging-sw.js] Received background message ', payload);
    const notificationTitle = payload.data["sender"];
    const notificationOptions = {
      body : payload.data["subject"], icon : '/silverpeas/util/icons/desktop-user-notification.png',
      data : payload.data
    };

    // Service worker notification management
    self.addEventListener("notificationclick", function(event) {
       const pushData = event.notification.data;
       event.notification.close();
       self.clients.openWindow(pushData["permalink"]);
    });

    return self.registration.showNotification(notificationTitle, notificationOptions);
  });

}

const CACHE_NAME = 'spmobileOffline';
var cache;

self.addEventListener('install', (event) => {
  event.waitUntil((async () => {
    cache = await caches.open(CACHE_NAME);
    await cache.addAll(OFFLINE_URLS);
  })());
});

self.addEventListener('activate', function(event) {
  event.waitUntil((async () => {
    cache = await caches.open(CACHE_NAME);
  })());
});


self.addEventListener('fetch', function(event) {

    if (event.request.method == 'GET' && event.request.url.startsWith('http') ) {

    event.respondWith(
      caches.match(event.request).then(function(response) {
        if (response) {
          //console.log('Réponse trouvée en cache:', response);
          return response;
        }
        //console.log('Pas de réponse trouvée en cache. Sur le point de la récupérer via le réseau...');

        return fetch(event.request).then(function(response) {

          try {
            if (event.request.url.includes('.cache.js')) {

              console.log('clean old nocache.js');
              cache.keys().then(function(cachedRequests) {
                cachedRequests.forEach(function(cachedRequest) {
                  if (cachedRequest.url.includes('.cache.js')) {
                    console.log('old cache.js found !');
                    cache.delete(cachedRequest);
                  }
                });
              });

            }
            cache.put(event.request.clone(), response.clone());

          } catch(error) {
            if (error.name === 'QuotaExceededError') {
              console.log('cleaning cache');
              cache.keys().then(function(cachedRequests) {
                cachedRequests.forEach(function(cachedRequest) {
                  if (cachedRequest.url.includes('/services/')) {
                    cache.delete(cachedRequest);
                  }
                });
              });
            }
          }

          return response;
        }).catch(function(error) {
          console.error('Récupération échouée:', error);
          throw error;
        });
      })
    );

  }
});